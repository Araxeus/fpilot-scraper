name: Check for Updates

on:
  schedule:
    # Run daily at 9:00 UTC
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  check:
    name: Check for New Version
    runs-on: windows-latest
    outputs:
      new_version: ${{ steps.check.outputs.new_version }}
      version: ${{ steps.check.outputs.version }}
      tag: ${{ steps.check.outputs.tag }}

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Check for updates
        id: check
        run: bun start

      - name: Upload artifact
        if: steps.check.outputs.new_version == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: fpilot-exe
          path: FPilot.exe
          if-no-files-found: error

      - name: Commit version file and create tag
        if: steps.check.outputs.new_version == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add version.txt
          git commit -m "Update to ${{ steps.check.outputs.version }}"
          git tag "${{ steps.check.outputs.tag }}"
          git push
          git push origin "${{ steps.check.outputs.tag }}"

  attest:
    name: Attest Build Provenance
    needs: check
    runs-on: ubuntu-latest
    if: needs.check.outputs.new_version == 'true'

    permissions:
      id-token: write
      contents: read
      attestations: write

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v7
        with:
          name: fpilot-exe

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: FPilot.exe

  release:
    name: Create Release
    needs: [check, attest]
    runs-on: ubuntu-latest
    if: needs.check.outputs.new_version == 'true'

    permissions:
      contents: write
      actions: read

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v7
        with:
          name: fpilot-exe

      - name: Generate release notes
        run: |
          VERSION="${{ needs.check.outputs.version }}"
          TAG="${{ needs.check.outputs.tag }}"
          # Extract version number (e.g., "v0.6.5" from "Beta v0.6.5")
          VERSION_ANCHOR=$(echo "$VERSION" | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+')
          REPO_URL="${{ github.server_url }}/${{ github.repository }}"
          RUN_URL="${REPO_URL}/actions/runs/${{ github.run_id }}"

          cat > release_notes.md << EOF
          ## FilePilot ${VERSION}

          **Release Notes**: https://filepilot.tech/starlog#${VERSION_ANCHOR}

          ---

          > *Automatically packaged using GitHub Actions ([logs](${RUN_URL})) - see [Attestations](${REPO_URL}/attestations) for build provenance*
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check.outputs.tag }}
          name: FilePilot ${{ needs.check.outputs.version }}
          files: FPilot.exe
          body_path: release_notes.md
          draft: false
          prerelease: false
